name: Run Tests and Create PR ipv4

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:

jobs:
  test-and-pr:
    runs-on: ubuntu-latest
    if: "!contains(github.event.head_commit.message, 'Auto-update test results and reports')"

    permissions:
      contents: write
      pull-requests: write
      actions: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "24"
          #cache: 'npm'

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.21"

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install Python dependencies
        run: pip install -r requirements.txt

      - name: Install dependencies
        run: npm install -g cnpm --registry=https://registry.npmmirror.com && cnpm install
      - name: Run fetch script
        run: npm run fetch

      - name: Run extract script
        run: npm run extract

      - name: Run check script
        run: npm run check

      - name: Run start script
        run: |
          # æŸ¥æ‰¾æœ€æ–°ç”Ÿæˆçš„ connectivity_results æ–‡ä»¶
          LATEST_FILE=$(ls -t connectivity_results-*.json | head -n 1)
          if [ -n "$LATEST_FILE" ]; then
            echo "ä½¿ç”¨æ–‡ä»¶: $LATEST_FILE"
            node generate-test-report.js -f "$LATEST_FILE"
          else
            echo "æœªæ‰¾åˆ° connectivity_results-*.json æ–‡ä»¶ï¼Œä½¿ç”¨é»˜è®¤æ–‡ä»¶"
            npm run start
          fi

      - run: npm run clean
      - name: Check for changes
        id: verify-changed-files
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
          else
            echo "changed=false" >> $GITHUB_OUTPUT
          fi

      - name: Commit changes
        if: steps.verify-changed-files.outputs.changed == 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add .
          git commit -m "Auto-update test results and reports [skip ci]"

      - name: Push changes
        id: push-changes
        if: steps.verify-changed-files.outputs.changed == 'true'
        run: |
          # Determine the correct base branch
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            BASE_BRANCH="${{ github.base_ref }}"
          else
            # Extract branch name from refs/heads/branch-name or refs/pull/XX/merge
            BASE_BRANCH=$(echo "${{ github.ref }}" | sed 's|^refs/heads/||' | sed 's|^refs/pull/[0-9]*/merge||')
            # If it's a pull request merge, use the base ref
            if [[ "$BASE_BRANCH" == "" ]]; then
              BASE_BRANCH="main"
            fi
          fi

          # Fallback to main if base branch is still empty or invalid
          if [[ "$BASE_BRANCH" == "" ]] || [[ "$BASE_BRANCH" =~ [0-9]+/merge ]]; then
            BASE_BRANCH="main"
          fi

          BRANCH_NAME="auto-update/${BASE_BRANCH}/$(date +%Y%m%d-%H%M%S)-${{ github.run_id }}"

          git checkout -b "$BRANCH_NAME"
          git push --set-upstream origin "$BRANCH_NAME"

          echo "branch-name=$BRANCH_NAME" >> $GITHUB_OUTPUT
          echo "base-branch=$BASE_BRANCH" >> $GITHUB_OUTPUT

      - name: Debug branch info
        if: steps.verify-changed-files.outputs.changed == 'true'
        run: |
          echo "Current branch: $(git branch --show-current)"
          echo "Remote branches:"
          git branch -r
          echo "Push output branch: ${{ steps.push-changes.outputs.branch-name }}"
          echo "Base branch: ${{ steps.push-changes.outputs.base-branch }}"

      - name: Setup GitHub CLI
        if: steps.verify-changed-files.outputs.changed == 'true'
        run: |
          echo "GitHub CLI version:"
          gh version

      - name: Create Pull Request with GitHub CLI
        if: steps.verify-changed-files.outputs.changed == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_BODY=$(cat << 'EOF'
          ## Summary

          This PR contains automated updates from the test workflow:

          - âœ… Extract script completed successfully
          - âœ… Check script completed successfully
          - âœ… Start script completed successfully

          The workflow has generated updated test results and reports.

          ## Test plan

          - [ ] Review the generated test results
          - [ ] Verify connectivity check data
          - [ ] Validate report formatting

          ğŸ¤– Generated with [Claude Code](https://claude.com/claude-code)
          EOF
          )

          # Create the pull request using gh CLI
          gh pr create \
            --base "${{ steps.push-changes.outputs.base-branch }}" \
            --head "${{ steps.push-changes.outputs.branch-name }}" \
            --title "Auto-update test results and reports" \
            --body "$PR_BODY" \
            --repo "${{ github.repository }}"
            # --label "automated,test-results" \

      - name: Install Cloudflare WARP
        run: |
          # æ£€æµ‹æ“ä½œç³»ç»Ÿç±»å‹
          . /etc/os-release
          OS=$ID

          if [[ "$OS" == "ubuntu" || "$OS" == "debian" ]]; then
            echo "--- Installing for Debian/Ubuntu ---"
            sudo apt-get update
            sudo apt-get install -y curl gpg lsb-release
            curl -fsSL https://pkg.cloudflareclient.com/pubkey.gpg | sudo gpg --yes --dearmor --output /usr/share/keyrings/cloudflare-warp-archive-keyring.gpg
            echo "deb [signed-by=/usr/share/keyrings/cloudflare-warp-archive-keyring.gpg] https://pkg.cloudflareclient.com/ $(lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/cloudflare-client.list
            sudo apt-get update && sudo apt-get install -y cloudflare-warp

          elif [[ "$OS" == "rhel" || "$OS" == "centos" || "$OS" == "fedora" || "$OS" == "rocky" || "$OS" == "almalinux" ]]; then
            echo "--- Installing for RHEL/CentOS/Fedora ---"
            sudo rpm -e 'gpg-pubkey(4fa1c3ba-61abda35)' || true
            sudo rpm --import https://pkg.cloudflareclient.com/pubkey.gpg
            curl -fsSL https://pkg.cloudflareclient.com/cloudflare-warp-ascii.repo | sudo tee /etc/yum.repos.d/cloudflare-warp.repo
            if command -v dnf &> /dev/null; then
              sudo dnf update -y && sudo dnf install -y cloudflare-warp
            else
              sudo yum update -y && sudo yum install -y cloudflare-warp
            fi
          else
            echo "Unsupported OS: $OS"
            exit 1
          fi

      - name: Register and connect to WARP
        run: |
          echo "--- Registering WARP client ---"
          sudo warp-cli --accept-tos registration new

          echo "--- Connecting to WARP ---"
          sudo warp-cli --accept-tos connect

          # åˆå§‹åŒ–å¾ªç¯å˜é‡
          MAX_ATTEMPTS=6  # 60 seconds / 10 seconds per attempt
          ATTEMPT=1

          echo "--- Waiting for IPv6 connectivity (max 1 minute) ---"

          while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
            echo "Attempt $ATTEMPT/$MAX_ATTEMPTS: Pinging https://ipv6.test-ipv6.com/ via IPv6..."

            if curl -6 -sL -o /dev/null https://ipv6.test-ipv6.com/; then
              echo "âœ… IPv6 connectivity is successful!"
              echo "WARP is ready."
              break
            fi

            echo "âŒ Attempt $ATTEMPT failed. Waiting for 10 seconds..."
            sleep 10
            ATTEMPT=$((ATTEMPT + 1))
          done

          if [ $ATTEMPT -gt $MAX_ATTEMPTS ]; then
            echo "âŒ Error: Failed to establish IPv6 connectivity after 1 minute."
            echo "--- WARP Status for Debugging ---"
            sudo warp-cli --accept-tos status
            exit 1
          fi

      - name: Verify IPv6 Connection and run tests
        run: |
          echo "--- WARP Status ---"
          sudo warp-cli --accept-tos status

          echo "--- Checking public IPv6 address ---"
          IPV6_ADDR=$(curl -6 -s https://ifconfig.co)
          echo "Detected IPv6 Address: $IPV6_ADDR"

          echo "--- Pinging an IPv6 address ---"
          ping6 -c 4 ipv6.google.com

          echo "======================================================"
          echo "Now you can run your tests that require IPv6 access."
          echo "======================================================"

          # åœ¨è¿™é‡Œæ‰§è¡Œä½ çœŸæ­£éœ€è¦ IPv6 çš„æµ‹è¯•å‘½ä»¤
          # ä¾‹å¦‚ï¼Œè¿™ä¸ªå‘½ä»¤ç°åœ¨åº”è¯¥ä¼šæˆåŠŸ
          curl -6 -v -I https://ipv6.test-ipv6.com/

          # ä¾‹å¦‚: npm run test-ipv6
          # ä¾‹å¦‚: python my_test_script.py
